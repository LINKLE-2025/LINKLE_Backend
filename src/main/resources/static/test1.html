<!doctype html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <title>Spring Boot Test Page</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
        :root { color-scheme: light dark; }
        body {
            font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
            margin: 0; line-height: 1.6;
        }
        .wrap {
            display: grid; grid-template-columns: 1fr 340px;
            height: 100dvh;
        }
        #map { width: 100%; height: 100%; }
        .sidebar {
            border-left: 1px solid #e5e7eb; padding: 16px; overflow: auto;
        }
        .controls {
            display: flex; align-items: center; gap: 8px; margin-bottom: 12px;
            position: sticky; top: 0; background: inherit; padding-bottom: 8px;
        }
        .badge { display:inline-block; padding:2px 8px; border:1px solid #d1d5db; border-radius:999px; font-size:12px; }
        .item {
            border:1px solid #e5e7eb; border-radius:10px; padding:10px; margin-bottom:10px;
            box-shadow: 0 2px 8px rgba(0,0,0,.05);
        }
        .item h4 { margin: 0 0 4px; font-size:16px; }
        .muted { color:#6b7280; font-size:12px; }
        .empty {
            border:1px dashed #d1d5db; border-radius:10px; padding:16px; text-align:center; color:#6b7280;
        }
        .hint { font-size:12px; color:#6b7280; margin-top:6px; }
        button, input[type="range"] {
            cursor: pointer;
        }
    </style>
    <!-- Kakao 지도 SDK: services 라이브러리 포함 -->
    <script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=bc33a8c71e1511a6319771ff29cdd526&libraries=services"></script>
</head>
<body>
<div class="wrap">
    <div id="map"></div>
    <aside class="sidebar">
        <div class="controls">
            <span class="badge">반경(m)</span>
            <input id="radiusRange" type="range" min="1" max="1000" value="1" step="1" />
            <span id="radiusValue">1</span>
            <button id="reSearchBtn">다시 검색</button>
        </div>
        <div id="status" class="hint">지도를 클릭하면 해당 지점 주변(기본 1m)의 음식점을 보여줍니다.</div>
        <div id="results"></div>
    </aside>
</div>

<script>
    (() => {
        let map, marker, places, lastClicked;
        const resultsEl = document.getElementById('results');
        const statusEl  = document.getElementById('status');
        const radiusEl  = document.getElementById('radiusRange');
        const radiusVal = document.getElementById('radiusValue');
        const reSearch  = document.getElementById('reSearchBtn');

        radiusEl.addEventListener('input', () => {
            radiusVal.textContent = radiusEl.value;
        });

        function initMap(centerLat, centerLng) {
            const container = document.getElementById('map');
            const options = {
                center: new kakao.maps.LatLng(centerLat, centerLng),
                level: 3,
            };
            map = new kakao.maps.Map(container, options);
            places = new kakao.maps.services.Places();

            // 클릭 시 마커 이동 + 검색
            kakao.maps.event.addListener(map, 'click', function(mouseEvent) {
                const latlng = mouseEvent.latLng;
                placeOrMoveMarker(latlng);
                lastClicked = latlng;
                searchRestaurants(latlng);
            });
        }

        function placeOrMoveMarker(latlng) {
            if (!marker) {
                marker = new kakao.maps.Marker({ position: latlng, map });
            } else {
                marker.setPosition(latlng);
            }
            // 클릭한 지점으로 부드럽게 이동
            map.panTo(latlng);
        }

        function searchRestaurants(latlng) {
            const radius = parseInt(radiusEl.value, 10) || 1;
            statusEl.textContent = `검색 중… (반경 ${radius}m)`;
            resultsEl.innerHTML = '';

            // 카테고리 FD6 = 음식점
            const options = {
                location: latlng,
                radius: radius, // m
                sort: kakao.maps.services.SortBy.DISTANCE
            };

            places.categorySearch('FD6', function(data, status) {
                if (status !== kakao.maps.services.Status.OK) {
                    resultsEl.innerHTML = `<div class="empty">결과가 없습니다. 반경을 늘려보세요.</div>`;
                    statusEl.textContent = `검색 완료 (0개)`;
                    return;
                }

                // distance 값은 location을 줬을 때 m 단위 문자열로 옵니다.
                const within = data.filter(item => {
                    const d = parseInt(item.distance || '999999', 10);
                    return !isNaN(d) && d <= radius;
                });

                statusEl.textContent = `검색 완료 (${within.length}개)`;
                if (within.length === 0) {
                    resultsEl.innerHTML = `
            <div class="empty">
              반경 ${radius}m 이내에는 결과가 없습니다.
              <div class="hint">※ 1m는 너무 좁을 수 있어요. 슬라이더로 반경을 늘려보세요.</div>
            </div>`;
                    return;
                }

                // 리스트 렌더
                const frag = document.createDocumentFragment();
                within.slice(0, 50).forEach((p, idx) => {
                    const div = document.createElement('div');
                    div.className = 'item';
                    div.innerHTML = `
            <h4>${idx+1}. ${p.place_name}</h4>
            <div class="muted">${p.road_address_name || p.address_name || ''}</div>
            <div class="muted">거리: ${p.distance ? p.distance + 'm' : '-'}</div>
            <div class="muted">${p.phone ? '전화: ' + p.phone : ''}</div>
          `;
                    div.addEventListener('click', () => {
                        // 리스트 아이템 클릭 시 지도 포커스 이동
                        const moveLatLng = new kakao.maps.LatLng(p.y, p.x);
                        map.panTo(moveLatLng);
                    });
                    frag.appendChild(div);
                });
                resultsEl.appendChild(frag);
            }, options);
        }

        // 다시 검색 버튼: 마지막 클릭 지점 기준 재검색
        reSearch.addEventListener('click', () => {
            if (lastClicked) {
                searchRestaurants(lastClicked);
            } else {
                statusEl.textContent = '먼저 지도를 클릭해 위치를 선택하세요.';
            }
        });

        // 시작 시 현재 위치 기준으로 지도 초기화 (허용 안 되면 기본 좌표: 서울시청)
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                pos => initMap(pos.coords.latitude, pos.coords.longitude),
                ()  => initMap(37.5662952, 126.9779451)
            );
        } else {
            initMap(37.5662952, 126.9779451);
        }
    })();
</script>
</body>
</html>
