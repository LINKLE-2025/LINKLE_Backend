<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <title>ì¹´ì¹´ì˜¤ë§µ + ì»¤ìŠ¤í…€ì˜¤ë²„ë ˆì´ + ë‚ ì”¨</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- ìŠ¤íƒ€ì¼ -->
  <style>
    html, body {height:100%; margin:0;}
    #map {width:100%; height:100%;}

    /* ì˜¤ë²„ë ˆì´ ê¸°ë³¸ ì»¨í…Œì´ë„ˆ */
    .place-overlay {
      position: relative;
      background:#fff;
      border-radius:12px;
      box-shadow:0 8px 24px rgba(0,0,0,.16);
      width:320px;
      overflow:hidden;
      font-family: system-ui, -apple-system, "Apple SD Gothic Neo", "Noto Sans KR", sans-serif;
    }
    .place-header {
      display:flex; align-items:center; gap:12px;
      padding:12px 14px; border-bottom:1px solid #eee;
    }
    .place-thumb {
      width:64px; height:64px; flex:none; border-radius:8px; object-fit:cover; background:#f2f2f2;
    }
    .place-title {font-weight:700; font-size:16px; line-height:1.2;}
    .place-body {padding:12px 14px; display:grid; gap:6px; font-size:13px; color:#333;}
    .muted {color:#666;}
    .actions {display:flex; gap:8px; margin-top:6px;}
    .btn {
      appearance:none; border:1px solid #e5e5e5; border-radius:8px; padding:8px 10px; font-size:12px;
      background:#fafafa; cursor:pointer; text-decoration:none; color:#222; display:inline-flex; align-items:center; gap:6px;
    }
    .btn:hover {background:#f0f0f0;}
    .close-x {
      position:absolute; top:8px; right:8px; width:28px; height:28px; border:none; border-radius:50%;
      background:#f6f6f6; cursor:pointer; font-weight:700;
    }
    .weather {
      display:flex; align-items:center; gap:10px; padding:10px 14px; background:#fbfbff; border-top:1px dashed #e6e8ff;
      font-size:13px;
    }
    .weather .temp {font-weight:700; font-size:14px;}
    .loading {color:#666; font-style:italic;}
    .error {color:#d33; font-weight:600;}
  </style>

  <!-- ì¹´ì¹´ì˜¤ë§µ JS SDK -->
  <script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=bc33a8c71e1511a6319771ff29cdd526&libraries=services"></script>
</head>
<body>
<div id="map"></div>

<script>
  // ====== ì„¤ì •ê°’ ======
  const OPENWEATHERMAP_API_KEY = "3bbe8ca3edf58696489aa029e6758038"; // ë³¸ì¸ í‚¤ë¡œ êµì²´
  const OPENWEATHER_ENDPOINT = "https://api.openweathermap.org/data/2.5/weather";

  // ì˜ˆì‹œ ì¥ì†Œ ë°ì´í„° (ì›í•˜ëŠ” ë§Œí¼ ì¶”ê°€/DB ì—°ë™ ê°€ëŠ¥)
  const PLACES = [
    {
      id: "sch-001",
      name: "ì„œìš¸ì¤‘ì‚°ì´ˆë“±í•™êµ",
      lat: 37.604486, lon: 126.922842,
      address: "ì„œìš¸ ì€í‰êµ¬ ì¤‘ì‚°ì„œê¸¸ 61 (ì¤‘ì‚°ë™ 212)",
      phone: "02-373-6305",
      photo: "https://via.placeholder.com/128x96?text=School" // ì‹¤ì œ ì´ë¯¸ì§€ URLë¡œ êµì²´ ê°€ëŠ¥
    },
    // {id:"...", name:"...", lat:..., lon:..., address:"...", phone:"", photo:""}
  ];

  // ====== ì§€ë„ ì´ˆê¸°í™” ======
  const map = new kakao.maps.Map(document.getElementById("map"), {
    center: new kakao.maps.LatLng(37.5665, 126.9780), // ì„œìš¸ ì‹œì²­ ë¶€ê·¼
    level: 6
  });

  // ====== ê³µìš© ì˜¤ë²„ë ˆì´ ì¸ìŠ¤í„´ìŠ¤ (í•œ ê°œë§Œ ì¨ì„œ ì„±ëŠ¥/ê´€ë¦¬ ìš©ì´) ======
  const overlay = new kakao.maps.CustomOverlay({ yAnchor: 1 });

  // ====== ë§ˆì»¤ ìƒì„± & í´ë¦­ ì´ë²¤íŠ¸ ======
  PLACES.forEach(place => {
    const marker = new kakao.maps.Marker({
      map,
      position: new kakao.maps.LatLng(place.lat, place.lon),
      title: place.name
    });

    kakao.maps.event.addListener(marker, "click", async () => {
      // ë¨¼ì € ë¡œë”© ìƒíƒœì˜ ì˜¤ë²„ë ˆì´ë¥¼ ë„ìš´ ë’¤ ë‚ ì”¨ ê°€ì ¸ì™€ ê°±ì‹ 
      const loadingHTML = buildOverlayHTML(place, { loading: true });
      overlay.setContent(loadingHTML);
      overlay.setPosition(marker.getPosition());
      overlay.setMap(map);
      attachCloseHandler();

      try {
        const weather = await fetchWeather(place.lat, place.lon);
        const contentHTML = buildOverlayHTML(place, { weather });
        overlay.setContent(contentHTML);
        attachCloseHandler();
      } catch (err) {
        const errorHTML = buildOverlayHTML(place, { error: err?.message || "ë‚ ì”¨ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤." });
        overlay.setContent(errorHTML);
        attachCloseHandler();
      }
    });
  });

  // ====== ê¸¸ì°¾ê¸° ë§í¬(ì¹´ì¹´ì˜¤ë§µ) ìƒì„± ======
  function buildDirectionsURL(lat, lon, name) {
    // ì¹´ì¹´ì˜¤ë§µ ì¥ì†Œì´ë™ (ì›¹)
    const q = encodeURIComponent(name || "ëª©ì ì§€");
    return `https://map.kakao.com/link/to/${q},${lat},${lon}`;
  }

  // ====== ë‚ ì”¨ ê°€ì ¸ì˜¤ê¸° (OpenWeatherMap: ì„­ì”¨, í•œêµ­ì–´) ======
  async function fetchWeather(lat, lon) {
    const url = `${OPENWEATHER_ENDPOINT}?lat=${lat}&lon=${lon}&appid=${OPENWEATHERMAP_API_KEY}&units=metric&lang=kr`;
    const res = await fetch(url);
    if (!res.ok) throw new Error("OpenWeather ì‘ë‹µ ì˜¤ë¥˜");
    const data = await res.json();
    return {
      temp: Math.round(data.main.temp),
      feels: Math.round(data.main.feels_like),
      desc: data.weather?.[0]?.description || "ë‚ ì”¨ ì •ë³´",
      icon: data.weather?.[0]?.icon || null, // ex) "10d"
      wind: data.wind?.speed,
      humidity: data.main?.humidity
    };
  }

  // ====== ì˜¤ë²„ë ˆì´ HTML ìƒì„± ======
  function buildOverlayHTML(place, state) {
    const { name, address, phone, photo, lat, lon } = {
      ...place, lat: place.lat, lon: place.lon
    };

    const directionsURL = buildDirectionsURL(lat, lon, name);

    // ìƒíƒœë¸”ë¡ (loading / error / weather)
    let statusBlock = "";
    if (state?.loading) {
      statusBlock = `<div class="weather"><span class="loading">ë‚ ì”¨ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</span></div>`;
    } else if (state?.error) {
      statusBlock = `<div class="weather"><span class="error">âš  ${state.error}</span></div>`;
    } else if (state?.weather) {
      const w = state.weather;
      const iconURL = w.icon ? `https://openweathermap.org/img/wn/${w.icon}@2x.png` : "";
      statusBlock = `
          <div class="weather">
            ${iconURL ? `<img src="${iconURL}" alt="ë‚ ì”¨" width="40" height="40" />` : ""}
            <div>
              <div><span class="temp">${w.temp}â„ƒ</span> Â· ì²´ê° ${w.feels}â„ƒ</div>
              <div class="muted">${w.desc} Â· ìŠµë„ ${w.humidity ?? "-"}% Â· ë°”ëŒ ${w.wind ?? "-"} m/s</div>
            </div>
          </div>
        `;
    }

    return `
        <div class="place-overlay">
          <button class="close-x" title="ë‹«ê¸°" onclick="window.__closeOverlay && window.__closeOverlay()">Ã—</button>
          <div class="place-header">
            <img class="place-thumb" src="${photo || ""}" alt="thumb" onerror="this.style.display='none'">
            <div class="place-title">${escapeHTML(name)}</div>
          </div>
          <div class="place-body">
            ${address ? `<div>ğŸ“ <span class="muted">${escapeHTML(address)}</span></div>` : ""}
            ${phone ? `<div>ğŸ“ <a class="muted" href="tel:${phone.replaceAll('-','')}">${escapeHTML(phone)}</a></div>` : ""}
            <div class="actions">
              <a class="btn" href="${directionsURL}" target="_blank" rel="noopener">ğŸ§­ ê¸¸ì°¾ê¸°</a>
              ${phone ? `<a class="btn" href="tel:${phone.replaceAll('-','')}" target="_blank" rel="noopener">â˜ ì „í™”</a>` : ""}
            </div>
          </div>
          ${statusBlock}
        </div>
      `;
  }

  // ì˜¤ë²„ë ˆì´ ë‹«ê¸° í•¸ë“¤ëŸ¬ ë°”ì¸ë”©
  function attachCloseHandler() {
    window.__closeOverlay = () => overlay.setMap(null);
  }

  // XSS ê°„ë‹¨ ë°©ì§€
  function escapeHTML(str="") {
    return String(str)
            .replaceAll("&", "&amp;")
            .replaceAll("<", "&lt;")
            .replaceAll(">", "&gt;")
            .replaceAll('"', "&quot;")
            .replaceAll("'", "&#039;");
  }

  // ì²« ì¥ì†Œë¡œ ìë™ ì´ë™(ì„ íƒ)
  if (PLACES[0]) {
    const c = new kakao.maps.LatLng(PLACES[0].lat, PLACES[0].lon);
    map.setCenter(c);
  }
</script>
</body>
</html>
